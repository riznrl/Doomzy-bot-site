<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Doomzy — Resources</title>
  <link rel="stylesheet" href="/css/theme.css">
</head>
<body>
  <script defer src="/js/nav.js"></script>

  <div class="container">
    <h1>Resources</h1>

    <div class="card" style="margin-bottom:16px">
      <form id="resForm" enctype="multipart/form-data">
        <input type="file" name="file" id="resFile" required />
        <button class="btn-primary" type="submit">Upload</button>
        <span class="notice" id="resNote"></span>
      </form>
    </div>

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 style="margin:0">Library</h3>
        <button class="btn-primary" id="resRefresh" style="padding:.4rem .7rem;font-size:.9rem">Refresh</button>
      </div>
      <div id="grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:12px;margin-top:12px"></div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script src="/js/notifications.js"></script>
  <script>
    function cell(att, meta){
      const url = att.proxyUrl || att.url;
      let inner = '';
      if(att.kind==='image'){
        inner = `<img src="${url}" alt="${att.name}" style="width:100%;height:180px;object-fit:cover;border-radius:12px;border:1px solid rgba(255,255,255,.08)" />`;
      } else if(att.kind==='video'){
        inner = `<video controls style="width:100%;height:180px;border-radius:12px;border:1px solid rgba(255,255,255,.08)"><source src="${url}"></video>`;
      } else if(att.kind==='audio'){
        inner = `<div style="padding:8px"><strong>${att.name}</strong><audio controls style="width:100%"><source src="${url}"></audio></div>`;
      } else if(att.kind==='pdf'){
        inner = `<iframe src="${url}" style="width:100%;height:180px;border-radius:12px;border:1px solid rgba(255,255,255,.08)"></iframe>`;
      } else {
        inner = `<div class="notice" style="padding:8px"><strong>${att.name}</strong><br/><a href="${url}" target="_blank" rel="noopener">Open</a></div>`;
      }
      return `
      <div class="media-card">
        ${inner}
        <div style="opacity:.8;font-size:.85rem;margin-top:6px">${meta.author||'Someone'} • ${new Date(meta.ts).toLocaleString()}</div>
      </div>`;
    }

    async function loadRes(){
      const r = await fetch('/api/resources/list', { credentials:'include' });
      const j = await r.json();
      const grid = document.getElementById('grid');
      grid.innerHTML = '';
      if(!j.ok){ grid.innerHTML = '<p class="notice">Could not load resources.</p>'; return; }
      j.items.forEach(m=>{
        if(!m.attachments?.length) return;
        m.attachments.forEach(att=>{
          grid.insertAdjacentHTML('beforeend', cell(att, m));
        });
      });
    }

    document.getElementById('resForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const note = document.getElementById('resNote');
      const fd = new FormData(e.target);
      const r = await fetch('/api/resources/upload', { method:'POST', body: fd, credentials:'include' });
      const j = await r.json();
      if(j.ok){ note.textContent = j.chunked ? `Uploaded in ${j.total} parts.` : 'Uploaded!'; e.target.reset(); loadRes(); }
      else { note.textContent = 'Upload failed: ' + (j.error || r.status); }
    });

    document.getElementById('resRefresh').onclick = loadRes;
    loadRes();
  </script>
</body>
</html>
